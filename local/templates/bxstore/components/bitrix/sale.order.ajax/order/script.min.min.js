BX.saleOrderAjax={BXCallAllowed:false,options:{},indexCache:{},controls:{},modes:{},properties:{},init:function(c){var d=this;this.options=c;window.submitFormProxy=BX.proxy(function(){d.submitFormProxy.apply(d,arguments)},this);BX(function(){d.initDeferredControl()});BX(function(){d.BXCallAllowed=true});this.controls.scope=BX("bx-soa-order");BX.bindDelegate(this.controls.scope,"click",{className:"-bx-popup-set-mode-add-loc"},function(){var a=BX.create("input",{attrs:{type:"hidden",name:"PERMANENT_MODE_STEPS",value:"1"}});BX.prepend(a,BX("bx-soa-order"));d.BXCallAllowed=false;BX.Sale.OrderAjaxComponent.sendRequest()})},cleanUp:function(){for(var b in this.properties){if(this.properties.hasOwnProperty(b)){if(typeof this.properties[b].input!="undefined"){BX.unbindAll(this.properties[b].input);this.properties[b].input=null}if(typeof this.properties[b].control!="undefined"){BX.unbindAll(this.properties[b].control)}}}this.properties={}},addPropertyDesc:function(b){this.properties[b.id]=b.attributes;this.properties[b.id].id=b.id},initDeferredControl:function(){var l=this,r,k,o,n,s,q,t,m,p;if(typeof window.BX.locationsDeferred!="undefined"){this.BXCallAllowed=false;for(r in window.BX.locationsDeferred){window.BX.locationsDeferred[r].call(this);window.BX.locationsDeferred[r]=null;delete (window.BX.locationsDeferred[r]);this.properties[r].control=window.BX.locationSelectors[r];delete (window.BX.locationSelectors[r])}}for(r in this.properties){if(this.properties[r].isZip){k=this.controls.scope.querySelector('[data-property-id-row="'+r+'"]');if(BX.type.isElementNode(k)){o=k.querySelector('input[type="text"]');if(BX.type.isElementNode(o)){this.properties[r].input=o;n=false;for(s in this.properties){if(this.properties[s].type=="LOCATION"){n=s;break}}if(n!==false){BX.bindDebouncedChange(o,function(a){var b=BX("ZIP_PROPERTY_CHANGED");b&&(b.value="Y");o=null;k=null;if(BX.type.isNotEmptyString(a)&&/^\s*\d+\s*$/.test(a)&&a.length>3){l.getLocationsByZip(a,function(c){l.properties[n].control.setValueByLocationIds(c)},function(){try{}catch(c){}})}})}}}}if(this.properties[r].type=="LOCATION"){if(typeof this.properties[r].control!="undefined"){q=this.properties[r].control;t=q.getSysCode();if(typeof this.properties[r].altLocationPropId!="undefined"){if(t=="sls"){q.replaceTemplate("nothing-found",this.options.messages.notFoundPrompt)}if(t=="slst"){(function(b,a){a.setOption("pseudoValues",["other"]);a.bindEvent("control-before-display-page",function(c){a=null;var e=c.getParentValue();if(e==this.getOption("rootNodeValue")||!this.checkCanSelectItem(e)){return}var d=c.getControl();if(typeof d.vars.cache.nodes.other=="undefined"){d.fillCache([{CODE:"other",DISPLAY:l.options.messages.otherLocation,IS_PARENT:false,VALUE:"other"}],{modifyOrigin:true,modifyOriginPosition:"prepend"})}});m=BX("LOCATION_ALT_PROP_DISPLAY_MANUAL["+parseInt(b)+"]");a.bindEvent("after-select-real-value",function(){if(BX.type.isDomNode(m)){m.value="0"}});a.bindEvent("after-select-pseudo-value",function(){if(BX.type.isDomNode(m)){m.value="1"}});a.bindEvent("before-set-value",function(){if(BX.type.isDomNode(m)){m.value="0"}});if(BX.type.isDomNode(m)&&m.value=="1"){p=a.getAdapterAtPosition(a.getStackSize()-1);if(typeof p!="undefined"&&p!==null){p.setValuePair("other",l.options.messages.otherLocation)}}})(r,q)}}}}}this.BXCallAllowed=true;if(BX.Sale.OrderAjaxComponent){BX.Sale.OrderAjaxComponent.locationsCompletion()}},checkMode:function(h,g){if(g=="altLocationChoosen"){if(this.checkAbility(h,"canHaveAltLocation")){var f=this.getInputByPropId(this.properties[h].altLocationPropId);var e=this.properties[h].altLocationPropId;if(f!==false&&f.value.length>0&&!f.disabled&&this.properties[e].valueSource!="default"){return true}}}return false},checkAbility:function(e,f){if(typeof this.properties[e]=="undefined"){this.properties[e]={}}if(typeof this.properties[e].abilities=="undefined"){this.properties[e].abilities={}}if(typeof this.properties[e].abilities!="undefined"&&this.properties[e].abilities[f]){return true}if(f=="canHaveAltLocation"){if(this.properties[e].type=="LOCATION"){if(typeof this.properties[e].altLocationPropId!="undefined"&&typeof this.properties[this.properties[e].altLocationPropId]){var d=this.properties[e].altLocationPropId;if(typeof this.properties[e].control!="undefined"&&this.properties[e].control.getSysCode()=="slst"){if(this.getInputByPropId(d)!==false){this.properties[e].abilities[f]=true;return true}}}}}return false},getInputByPropId:function(d){if(typeof this.properties[d].input!="undefined"){return this.properties[d].input}var f=this.getRowByPropId(d);if(BX.type.isElementNode(f)){var e=f.querySelector('input[type="text"]');if(BX.type.isElementNode(e)){this.properties[d].input=e;return e}}return false},getRowByPropId:function(d){if(typeof this.properties[d].row!="undefined"){return this.properties[d].row}var c=this.controls.scope.querySelector('[data-property-id-row="'+d+'"]');if(BX.type.isElementNode(c)){this.properties[d].row=c;return c}return false},getAltLocPropByRealLocProp:function(b){if(typeof this.properties[b].altLocationPropId!="undefined"){return this.properties[this.properties[b].altLocationPropId]}return false},toggleProperty:function(e,f,h){var g=this.properties[e];if(typeof g.row=="undefined"){g.row=this.getRowByPropId(e)}if(typeof g.input=="undefined"){g.input=this.getInputByPropId(e)}if(!f){if(!h){BX.hide(g.row)}g.input.disabled=true}else{if(!h){BX.show(g.row)}g.input.disabled=false}},submitFormProxy:function(h,g){var e=false;for(var f in this.properties){if(typeof this.properties[f].control!="undefined"&&this.properties[f].control==g){e=f;break}}if(h!="other"){if(this.BXCallAllowed){this.BXCallAllowed=false;setTimeout(function(){BX.Sale.OrderAjaxComponent.sendRequest()},20)}}},getPreviousAdapterSelectedNode:function(j,h){var g=h.getIndex();var i=j.getAdapterAtPosition(g-1);if(typeof i!=="undefined"&&i!=null){var k=i.getControl().getValue();if(typeof k!="undefined"){var l=j.getNodeByValue(k);if(typeof l!="undefined"){return l}return false}}return false},getLocationsByZip:function(h,f,g){if(typeof this.indexCache[h]!="undefined"){f.apply(this,[this.indexCache[h]]);return}var e=this;BX.ajax({url:this.options.source,method:"post",dataType:"json",async:true,processData:true,emulateOnload:true,start:true,data:{ACT:"GET_LOCS_BY_ZIP",ZIP:h},onsuccess:function(a){if(a.result){e.indexCache[h]=a.data;f.apply(e,[a.data])}else{g.call(e)}},onfailure:function(b,a){}})}};