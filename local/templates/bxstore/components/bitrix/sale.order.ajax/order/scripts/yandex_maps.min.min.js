BX.namespace("BX.Sale.OrderAjaxComponent.Maps");(function(){BX.Sale.OrderAjaxComponent.Maps={init:function(a){this.context=a||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=false;return this},initializePickUpMap:function(a){if(!ymaps){return}this.pickUpMap=new ymaps.Map("pickUpMap",{center:!!a?[a.GPS_N,a.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom});this.pickUpMap.behaviors.disable("scrollZoom");this.pickUpMap.events.add("click",BX.delegate(function(){if(this.pickUpMap.balloon.isOpen()){this.pickUpMap.balloon.close()}},this))},pickUpMapFocusWaiter:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.setPickUpMapFocus()}else{setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)}},setPickUpMapFocus:function(){var b,c,a;b=this.pickUpMap.geoObjects.getBounds();if(b&&b.length){c=b[1][0]-b[0][0];a=b[1][1]-b[0][1];b[0][0]-=c/10;b[0][1]-=a/10;b[1][0]+=c/10;b[1][1]+=a/10;this.pickUpMap.setBounds(b,{checkZoomRange:true})}},showNearestPickups:function(b,d){if(!ymaps){return}var a=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto";var c=this.pickUpOptions.geoLocationMaxTime||5000;ymaps.geolocation.get({provider:a,timeOut:c}).then(BX.delegate(function(f){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;f.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon");this.pickUpMap.geoObjects.add(f.geoObjects);b(f)}},this),BX.delegate(function(){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;d()}},this))},buildBalloons:function(b){if(!ymaps){return}var d=this;this.pickUpPointsJSON=[];for(var a=0;a<b.length;a++){var c=this.getStoreInfoHtml(b[a]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[b[a].GPS_N,b[a].GPS_S]},properties:{storeId:b[a].ID}});var f=new ymaps.Placemark([b[a].GPS_N,b[a].GPS_S],{hintContent:BX.util.htmlspecialchars(b[a].TITLE)+"<br />"+BX.util.htmlspecialchars(b[a].ADDRESS),storeTitle:b[a].TITLE,storeBody:c,id:b[a].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass('<h3>{{ properties.storeTitle }}</h3>{{ properties.storeBody|raw }}<br /><a class="btn btn-sm btn-primary" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var e=document.querySelector("a[data-store]");if(e){BX.bind(e,"click",this.selectStoreByClick)}},clear:function(){var e=document.querySelector("a[data-store]");if(e){BX.unbind(e,"click",this.selectStoreByClick)}this.constructor.superclass.clear.call(this)},selectStoreByClick:function(g){var e=g.target||g.srcElement;if(d.pickUpMap.container.isFullscreen()){d.pickUpMap.container.exitFullscreen()}d.context.selectStore(e.getAttribute("data-store"));d.context.clickNextAction(g);d.pickUpMap.balloon.close()}})});if(BX("BUYER_STORE").value===b[a].ID){f.options.set("preset","islands#redDotIcon")}this.pickUpMap.geoObjects.add(f)}},selectBalloon:function(a){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.pickUpMap.geoObjects.each(BX.delegate(function(b){if(b.properties.get("id")){b.options.unset("preset")}if(b.properties.get("id")===a){b.options.set({preset:"islands#redDotIcon"});this.pickUpMap.panTo([b.geometry.getCoordinates()])}},this))}},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var a=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(b){if(b.properties.get("id")===a.value){b.options.set({preset:"islands#redDotIcon"})}else{if(parseInt(b.properties.get("id"))>0){b.options.unset("preset")}}})}},initializePropsMap:function(a){if(!ymaps){return}this.propsMap=new ymaps.Map("propsMap",{center:[a.lat,a.lon],zoom:a.zoom});this.propsMap.behaviors.disable("scrollZoom");this.propsMap.events.add("click",BX.delegate(function(c){var d=c.get("coords"),b;if(this.propsMap.geoObjects.getLength()===0){b=new ymaps.Placemark([d[0],d[1]],{},{draggable:true,preset:"islands#redDotIcon"});b.events.add(["parentchange","geometrychange"],function(){var g=BX("orderDescription"),j=b.geometry.getCoordinates(),h,k,i,f;if(g){h=g.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(h===-1){g.value=BX.message("SOA_MAP_COORDS")+": "+j[0]+", "+j[1]+"\r\n"+g.value}else{f=BX.message("SOA_MAP_COORDS")+": "+j[0]+", "+j[1];k=g.value.substring(0,h);i=g.value.substring(h+f.length);g.value=k+f+i}}});this.propsMap.geoObjects.add(b)}else{this.propsMap.geoObjects.get(0).geometry.setCoordinates([d[0],d[1]])}},this))},canUseRecommendList:function(){return this.pickUpPointsJSON&&this.pickUpPointsJSON.length},getRecommendedStoreIds:function(d){if(!d){return[]}var h=[];var c=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var f=0;f<c;f++){var j=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON});var g=j.getClosestTo(d);var b=g.properties.get("storeId");this.storeQueryResult[b]=g;h.push(b);this.pickUpPointsJSON.splice(j.indexOf(g),1)}return h},getDistance:function(b,d){if(!b||!d){return false}var a=this.storeQueryResult[d];var c=ymaps.coordSystem.geo.getDistance(b.geometry.getCoordinates(),a.geometry.getCoordinates());c=Math.round(c/100)/10;return c},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(a){var b="";if(a.ADDRESS){b+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(a.ADDRESS)+"<br />"}if(a.PHONE){b+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(a.PHONE)+"<br />"}if(a.SCHEDULE){b+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(a.SCHEDULE)+"<br />"}if(a.DESCRIPTION){b+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(a.DESCRIPTION)+"<br />"}return b}}})();